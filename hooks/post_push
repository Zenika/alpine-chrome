#!/bin/bash
set -e

CURRENT_VERSION_CHROMIUM=$(docker container run --rm --entrypoint "" zenika/alpine-chrome chromium-browser --version)
tag=${CURRENT_VERSION_CHROMIUM:9:2}
echo "ðŸš€ $IMAGE_NAME ðŸ‘‰ $tag"

tagStart=$(expr index "$IMAGE_NAME" :)
repoName=${IMAGE_NAME:0:tagStart-1}
docker tag "$IMAGE_NAME" "${repoName}:${tag}"
docker push "${repoName}:${tag}"

docker version
cat key.json | docker login -u _json_key --password-stdin https://gcr.io/zenika-hub

for published_tag in "latest" $tag; do
    docker tag "$IMAGE_NAME" "gcr.io/zenika-hub/$DOCKER_REPO:$published_tag"
    docker push "gcr.io/zenika-hub/$DOCKER_REPO:$published_tag"
    for region in "us" "eu" "asia"; do
        #publish in the different regions
        docker login -u _json_key -p "$(cat key.json)" https://$region.gcr.io/zenika-hub 
        docker tag "gcr.io/zenika-hub/$IMAGE_NAME" "$region.gcr.io/zenika-hub/$DOCKER_REPO:$published_tag"
        docker push "$region.gcr.io/zenika-hub/$DOCKER_REPO:$published_tag"
    done
done
